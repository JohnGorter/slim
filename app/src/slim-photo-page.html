<dom-module id="slim-photo-page">
    <template>
        <style>
        img  {
    fill: white;
}
                 div.screen {align-self:center;border-radius:7px;margin-top:60px;padding:0px;display:flex;justify-content: flex-start;align-items:center;flex-flow:column;width:80vw;min-width:400px;min-height:40vh;background-color: #303030;}
        </style>
        <div class="screen">
            <slim-image-control photo="{{data}}" on-photo-changed="_updateCanvas">foto control</slim-image-control>
            <br/>
            <br/>
            <input hidden="true" type="file" id="btnpic" accept="image/*">
            <canvas id="canvas" width="0" height="0" style="border:1px solid white;border-radius:5px;display:none;"></canvas>
            
            <div hidden$="{{!data}}">
                <paper-input label="titel" value="{{title}}"></paper-input>
            </div>

            <br/><br/><br/><br/>
            <template is="dom-if" if="{{!_hasImage(data)}}">
                <div>Maak een foto door bovenin op het camera icoon <br/>
                    te drukken. Sla de foto vervolgens op.</div>
                <!-- div that takes up no space but acts as a container to relative layout the arrows -->
                <div style="position: relative; width: 0; height: 0">
                <img style="width:50px;height:100px;border:0px solid red;transform:rotateY(180deg);opacity:0.5;position:relative;top:-150px;left:-170px;" src="./images/arrow.svg"  />
                <img style="width:50px;height:200px;border:0px solid red;opacity:0.5;position:relative;top:-300px;left:120px;" src="./images/arrow.svg"  />
                </div>
            </template>
         </div>
    </template>
    <script>
    Polymer({
      is:'slim-photo-page',
      properties:{
          data:{
              type:String, 
              value:''
          }
      },
      _updateCanvas(){
          setTimeout(()=>{
            this.$.canvas.getContext("2d").clearRect(0, 0, this.$.canvas.width, this.$.canvas.height);
          console.log('photo data changed');
            var img = document.createElement("img");
            img.onload = () => {
                var ctx =  this.$.canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);

                var MAX_WIDTH = 400;
                var MAX_HEIGHT = 300;
                var width = img.width;
                var height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                this.$.canvas.width = width;
                this.$.canvas.height = height;
                var ctx = this.$.canvas.getContext("2d");
                console.log('drawing new image..');
                ctx.drawImage(img, 0, 0, width, height);
                this.$.canvas.style.display='block';
            };
            img.src = this.data;
          },10);
      },
      ready(){
        this.$.btnpic.addEventListener('change', function(e){
            var data = e.target.files[0];
            var reader = new FileReader();
            var img = document.createElement("img");
            reader.onload = function(evt){
                img.src = reader.result;
                img.onload = () => {
                    var ctx =  this.$.canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 400;
                    var MAX_HEIGHT = 300;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    this.$.canvas.width = width;
                    this.$.canvas.height = height;
                    var ctx = this.$.canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    this.$.canvas.style.display='block';

                    var dataurl = this.$.canvas.toDataURL("image/png");
                    this.data = dataurl;
                };
                
            }.bind(this);
            reader.readAsDataURL(data);
        }.bind(this));
      },
      _hasImage(){
          return this.data != "";
      },
      _takepicture(){
          this.$.btnpic.click();
      },
      _save(){
          this.fire('photo-taken', { photo: this.data, title:this.title});
          this.data = "";
          this.$.canvas.style.display='none';
      },
    })
    </script>
</dom-module>