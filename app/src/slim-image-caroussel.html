<dom-module id="slim-image-caroussel">
    <template>
        <style>
            h1.title { position:relative;top:0px;text-align:left;margin-left:20px;align-self:flex-start;width:100vw;height:30px;color:white;z-index:99;font-family:tahoma;font-size:20px;font-weight:normal;text-shadow: 2px 2px black;font-variant-caps: small-caps;}
            h1.details { position:relative;top:500px;text-align:right;margin-right:20px;align-self:flex-end;width:100vw;height:30px;color:white;z-index:99;font-family:tahoma;font-size:12px;font-weight:normal;}
            #container { position:fixed ;display:flex;align-items:flex-start;justify-content:flex-start;flex-flow:column;width:100vw;height:90vh;background-color:#303030}
            .image { -webkit-transform: translate3d(0,0,0);position:absolute;width:100vw;height:80vh;}
            .image.moving {position:absolute;width:100vw;height:500px;opacity:1}
        </style>

        <div id="container">
            <!-- LOADING placeholder -->
            <template is="dom-if" if="{{!_isDone(renderedItemCount)}}">
                <img style="position:relative;height:50px;align-self:center;top:25%;" src="./images/loading.svg" />
            </template>

            <!-- image gallery container -->
            <template is="dom-repeat" items="{{images}}" rendered-item-count="{{renderedItemCount}}" initialCount="1">
                    <div class="image" alt$="{{item.title}}" style$='background:url("{{item.photo}}") no-repeat center center;background-size: contain;height:480px;width:100vw;z-index:{{index}};background-color:#303030'></div>
            </template>

             <!-- image manipulation toolbar -->
             <template is="dom-if" if="{{userprofile.isAdmin}}">
                    <slim-image-control photo="[[selectedPhoto.photo]]" title="bewerk foto" no-save no-new on-photo-delete="_delete" on-photo-changed="_save"></slim-image-control>
            </template> 

            <h1 class="title" id="title"></h1>
            <h1 class="details" id="details"></h1>
        </div>
    </script>
    </body>
</html>
    </template>
    <script>
    var player;
    var origleft;
    var finishpos = 0;
    var a = [];
    var interval;
    var i = 0;
    var ang = 90; //angle

    Polymer({
        observers:['_getImages(renderedItemCount)'],
        properties:{
            key:{
                type:String, 
                value:""
            },
            selectedPhoto:{
                type:Object, 
                value:{},
                notify:true
            },
            images:{
                type:Array, 
                notify:true 
            }
        },
        is:'slim-image-caroussel',
        _delete(e){
            e.preventDefault();
            e.stopPropagation();
           this.fire('photo-delete', { photo: e.detail.value, key: this.selectedPhoto[this.key]});
        },
        ready(){
          // let repeater finish...
          this.async(() => {
            this.listen(this, 'track', '_track');
          });
        },
        getImages(){
            a = [];
            var i = 0;
            const slot = Polymer.dom(this.root).querySelectorAll(".image");
            slot.forEach(function(element) {
                if (element.nodeType == 1) {
                    a.push(element);
                }
            }, this);
            this.selectedPhoto = this.images[this.images.length-1];
        },
        _getImages(){
            this.getImages();       
            this._updateDetails();     
        },
        _isDone(){
            return this.renderedItemCount != 0;
        },
        sortImages(){
            Array.prototype.slice.call(a).sort(function (a, b) {
                return a.style.zIndex > b.style.zIndex;
            });
        },
        addClass(elem, name) {
            if (!elem.classList.contains(name)){
                elem.className += " " + name;
            }
        },
        removeClass(elem, name) {
            elem.className = elem.className.replace(name, '');
        },
        _save(e){
            this.fire('photo-save', { photo: e.detail.value, key: this.selectedPhoto[this.key]});
        },
         _track(){
             var element;
             if (event.path)
                 element = event.path[0];
            else
                element = this._getTopMostImage();
            // only track images
            if (element.className.indexOf("image") < 0) return;

            if (event.detail.state == 'start'){
               origleft = element.style.left ?  element.style.left :0;
            }
            this.addClass(element, 'moving');
            newint = parseInt(origleft) + parseInt(event.detail.dx);
            element.style.left = `${newint}px`;
            if (event.detail.state == 'end'){
                this.completeGesture(element);
                this.removeClass(element, 'moving');
            }
        },
        completeGesture(elem){
            if (player != undefined) return;
            var center = (elem.getBoundingClientRect().width/2) + elem.getBoundingClientRect().left;
            var windowcenter = window.innerWidth /10;
            var elementcenter = (windowcenter * 5) - (elem.getBoundingClientRect().width/2);
            var direction = center < windowcenter ? -400: center > (windowcenter * 9) ? 1400: parseInt((elementcenter - elem.getBoundingClientRect().left));
            finishpos = direction == -400? -1: direction == 1400 ? 1 : 0;
            player = elem.animate([
                {transform:'translateX(0px)'},
                {transform:'translateX(' + direction + 'px)'}
            ], {
                duration: 400,
                iterations: 1,
                delay: 0,
            });

            player.onfinish = () => {
                player = undefined;
                var width = elem.getBoundingClientRect().width;
                elem.style.display = 'none';
                elem.style.left = finishpos < 0 ? '-400px' : finishpos > 0 ? '1400px': ((window.innerWidth/2) - (width/2)) + 'px';
                this.removeClass(elem,'moving');
                if (finishpos != 0) {
                    this.sortImages();
                    for (var i = 0; i < a.length; i++)
                    {
                        a[i].style.zIndex = parseInt(a[i].style.zIndex) + 1;
                        a[i].style.left = ((window.innerWidth/2) - (width/2)) + 'px';
                    }
                    elem.style.zIndex = -1;
                    var nextelement = this._getTopMostImage();
                    this.selectedPhoto = nextelement.__templatizeInstance.item;
                }
                elem.style.display = 'block';
                
                this._updateDetails();
                };
        },
        _dumpInfo(){
            for (var e of a){
                console.log('e' + e.tagName, e.style.zIndex);
            }
        },
         _updateDetails(){
            var e = this._getTopMostImage();
            if (e && e.attributes && e.attributes["alt"]){
               this.$.title.innerHTML = e.attributes["alt"].value;
            } else {
                this.$.title.innerHTML = "";
            }
            this.$.details.innerHTML = "Foto " + (a.length - a.indexOf(e)) + " van " + a.length + "";// + e.attributes["alt"].value;
         },
         _getTopMostImage(){
              // get the highest zindex
            var e = a[0];
            for (var i = 1; i < a.length; i++)
                if (a[i].style.zIndex > e.style.zIndex) e = a[i];
            return e;
         }
    })
    </script>
</dom-module>